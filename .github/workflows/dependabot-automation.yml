# .github/workflows/dependabot-automation.yml
#
# Automates Dependabot PRs by:
# 1. Updating poetry.lock to match new dependency versions (for Python dependency updates)
# 2. Installing dependencies and running automated fixes (ruff format, type checks, tests)
# 3. Committing any changes back to the Dependabot PR branch
# 4. Waiting for CI checks (Python 3.10 and 3.x) to complete
# 5. Auto-merging the PR if all checks pass
#
# Runs for all dependabot PRs (Python dependencies and GitHub Actions updates).
#
# Security: Only runs when github.actor == 'dependabot[bot]', which cannot be spoofed
# by external users. This is a GitHub-guaranteed trusted identity.
#
name: Dependabot Automation

on:
  pull_request:

jobs:
  automate:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - uses: abatilo/actions-poetry@v4

      - name: Update poetry.lock
        run: poetry lock

      - name: Install dependencies
        run: poetry install

      - name: Run formatting and linting fixes
        run: poetry run poe check:fix

      - name: Commit changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A
          git diff --staged --quiet || git commit -m "chore: update poetry.lock and apply auto-fixes"
          git push

      - name: Wait for CI to complete
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.head_ref }}
          check-regexp: '^checks \(.*\)$'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Auto-merge Dependabot PR
        run: gh pr merge --auto --squash "${{ github.event.pull_request.html_url }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
